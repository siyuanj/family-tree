<!-- <!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交互式家谱 (真·图谱版)</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        /* 样式基本保持不变，但为可点击的姓名添加了样式 */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; transition: background-color 0.3s; }
        h1 { text-align: center; color: #333; transition: color 0.3s; }
        .main-container { display: flex; flex-wrap: wrap; width: 98%; max-width: 1800px; margin: 20px auto; gap: 20px; }
        .controls { flex: 1; min-width: 300px; max-width: 350px; padding: 20px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: fit-content; transition: background-color 0.3s, box-shadow 0.3s; }
        .panel-section { border-top: 2px solid #eaf2fa; margin-top: 20px; padding-top: 20px; }
        .panel-section h2 { margin-top: 0; color: #2e75b5; padding-bottom: 10px; border-bottom: 2px solid #eaf2fa; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #333; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-group button { width: 100%; padding: 10px; background-color: #5b9bd5; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .form-group button:hover { background-color: #2e75b5; }
        #chart_div_container { flex: 3; min-width: 60%; min-height: 800px; }
        #orgchart_div, #timeline_div { width: 100%; height: 800px; border: 1px solid #ccc; background-color: #ffffff; border-radius: 8px; }
        
        .google-visualization-orgchart-node { border: 2px solid #5b9bd5; border-radius: 8px; background: #eaf2fa; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 8px !important; }
        /* 修正：高亮样式现在直接作用于图表库生成的节点上 */
        .highlight-node { background-color: #fff3cd !important; border-color: #ffc107 !important; }
        
        /* 核心改动：为节点内的可点击姓名添加样式 */
        .node-name { cursor: pointer; text-decoration: underline; font-weight: bold; padding: 2px; border-radius: 3px; }
        .node-name:hover { background-color: rgba(91, 155, 213, 0.2); }
        .node-name.focal-person { color: #d9534f; /* 焦点人物用醒目的红色 */ font-size: 1.1em; }
        .node-name.spouse { color: #2e75b5; }
        .date-info { font-size: 12px; color: #555; margin-top: 4px; }
        
        .action-btn-group { display: flex; gap: 10px; }
        .action-btn { flex-grow: 1; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .action-btn.active { box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); background-color: #2e75b5; color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions button { flex-grow: 1; padding: 10px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer;}
        #saveBtn { background-color: #5b9bd5; color: white; border-color: #5b9bd5;}

        @media print { body, .main-container { margin: 0; padding: 0; } .controls, h1 { display: none !important; } #chart_div_container { width: 100%; height: auto; border: none; box-shadow: none; } }
    </style>
</head>
<body>

    <h1>交互式家谱 (真·图谱版)</h1>

    <div class="main-container">
        <div class="controls">
            <div id="view-panel"><h2>视图切换</h2><div class="action-btn-group"><button id="orgchart-view-btn" class="action-btn active" onclick="switchView('orgchart')">家谱视图</button><button id="timeline-view-btn" class="action-btn" onclick="switchView('timeline')">时间轴</button><button class="action-btn" onclick="print()">打印</button></div></div>
            <div class="panel-section"><h2>数据管理</h2><div class="action-btn-group"><label for="import-file" class="action-btn" style="background-color: #17a2b8; color: white; text-align: center; line-height: 2;">导入</label><input type="file" id="import-file" accept=".json" style="display: none;"><button id="exportBtn" class="action-btn" style="background-color: #007bff; color: white;">导出</button><button id="resetBtn" class="action-btn" style="background-color: #6c757d; color: white;">重置</button></div></div>

            <div id="add-member-panel" class="panel-section">
                <h2>添加新成员</h2>
                <div class="form-group"><label for="newName">姓名:</label><input type="text" id="newName"></div>
                <div class="form-group"><label for="newGender">性别:</label><select id="newGender"><option value="male">男</option><option value="female">女</option></select></div>
                <div class="form-group"><label for="newInfo">生平信息:</label><input type="text" id="newInfo" placeholder="例如：19xx - 20xx"></div>
                <div class="form-group"><label for="newFather">父亲:</label><select id="newFather"></select></div>
                <div class="form-group"><label for="newMother">母亲:</label><select id="newMother"></select></div>
                <div class="form-group"><label for="newSpouse">配偶:</label><select id="newSpouse"></select></div>
                <div class="form-group"><label for="newTooltip">悬停提示:</label><textarea id="newTooltip" rows="3"></textarea></div>
                <div class="form-group"><button id="addBtn">添加到家谱</button></div>
            </div>

            <div id="details-panel" class="panel-section">
                <h2>成员详情</h2>
                <div id="details-content"><p>请点击家谱中的任意成员进行操作。</p></div>
                <div id="details-actions" class="action-btn-group" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div id="chart_div_container">
            <div id="orgchart_div"></div>
            <div id="timeline_div" style="display: none;"></div>
        </div>
    </div>
    
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <h2>编辑成员信息</h2>
            <input type="hidden" id="editId">
            <div class="form-group"><label for="editName">姓名:</label><input type="text" id="editName"></div>
            <div class="form-group"><label for="editGender">性别:</label><select id="editGender"><option value="male">男</option><option value="female">女</option></select></div>
            <div class="form-group"><label for="editInfo">生平信息:</label><input type="text" id="editInfo"></div>
            <div class="form-group"><label for="editFather">父亲:</label><select id="editFather"></select></div>
            <div class="form-group"><label for="editMother">母亲:</label><select id="editMother"></select></div>
            <div class="form-group"><label for="editSpouse">配偶:</label><select id="editSpouse"></select></div>
            <div class="form-group"><label for="editTooltip">悬停提示:</label><textarea id="editTooltip" rows="3"></textarea></div>
            <div class="modal-actions"><button id="saveBtn">保存</button><button id="cancelBtn">取消</button></div>
        </div>
    </div>

    <script type="text/javascript">
        google.charts.load('current', { packages:['orgchart', 'timeline'] });
        google.charts.setOnLoadCallback(initialize);

        const initialFamilyData = [
            { id: 'JiangZiwen', name: '蒋子文', gender: 'male', info: '未知 - 1991', spouseId: null, fatherId: null, motherId: null, tooltip: '家族的沅江分支始祖' },
            { id: 'ZengzuFu', name: '曾祖父', gender: 'male', info: '', spouseId: 'ZengzuMu', fatherId: 'JiangZiwen', motherId: null, tooltip: '由蒋子文过继' },
            { id: 'ZengzuMu', name: '曾祖母', gender: 'female', info: '', spouseId: 'ZengzuFu', fatherId: null, motherId: null, tooltip: '曾祖父的妻子' },
            { id: 'JiangLuosheng', name: '蒋罗生', gender: 'male', info: '1940 - 至今', spouseId: 'ZhuHui', fatherId: 'ZengzuFu', motherId: 'ZengzuMu', tooltip: '我的爷爷' },
            { id: 'ZhuHui', name: '祝辉', gender: 'female', info: '', spouseId: 'JiangLuosheng', fatherId: null, motherId: null, tooltip: '我的奶奶' },
            { id: 'JiangJianhong', name: '蒋建宏', gender: 'male', info: '1965年生', spouseId: null, fatherId: 'JiangLuosheng', motherId: 'ZhuHui', tooltip: '伯父' },
            { id: 'JiangLiyun', name: '蒋丽云', gender: 'female', info: '', spouseId: null, fatherId: 'JiangLuosheng', motherId: 'ZhuHui', tooltip: '姑姑' },
            { id: 'JiangJianjun', name: '蒋建军', gender: 'male', info: '1965年生', spouseId: 'LiuFang', fatherId: 'JiangLuosheng', motherId: 'ZhuHui', tooltip: '我的父亲' },
            { id: 'LiuFang', name: '刘芳', gender: 'female', info: '', spouseId: 'JiangJianjun', fatherId: null, motherId: null, tooltip: '我的母亲' },
            { id: 'JiangSiyuan', name: '蒋思源', gender: 'male', info: '2003年生', spouseId: null, fatherId: 'JiangJianjun', motherId: 'LiuFang', tooltip: '我' }
        ];

        let orgChart, timelineChart;
        let familyData = [];
        let focalPersonId = 'JiangSiyuan';
        let selectedPersonId = null;
        let currentView = 'orgchart';
        const LOCAL_STORAGE_KEY = 'familyTreeData_v3';

        function initialize() {
            orgChart = new google.visualization.OrgChart(document.getElementById('orgchart_div'));
            timelineChart = new google.visualization.Timeline(document.getElementById('timeline_div'));
            document.getElementById('orgchart_div').addEventListener('click', handleNodeClick);
            document.getElementById('addBtn').addEventListener('click', addMember);
            document.getElementById('saveBtn').addEventListener('click', saveChanges);
            document.getElementById('cancelBtn').addEventListener('click', closeEditModal);
            document.getElementById('editModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeEditModal(); });
            document.getElementById('exportBtn').addEventListener('click', exportDataToFile);
            document.getElementById('import-file').addEventListener('change', importDataFromFile);
            document.getElementById('resetBtn').addEventListener('click', resetToDefault);
            loadData();
        }

        function loadData(dataArray = null) {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            familyData = dataArray || (savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(initialFamilyData)));
            if (!familyData.find(p => p.id === focalPersonId)) {
                focalPersonId = familyData.length > 0 ? familyData[0].id : null;
            }
            redrawAll();
        }

        function saveDataAndRedraw() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(familyData));
            redrawAll();
        }
        
        function redrawAll() {
            drawCurrentView();
            updateAllDropdowns();
            updateDetailsPanel(selectedPersonId);
        }

        function drawCurrentView() {
            if (currentView === 'orgchart') drawOrgChart();
            else if (currentView === 'timeline') drawTimelineChart();
        }
        
        function drawOrgChart() {
            if (!familyData || familyData.length === 0) {
                document.getElementById('orgchart_div').innerHTML = "<p>家谱为空,请添加成员。</p>";
                return;
            }
            const dataTable = buildDataTableForFocalPerson(focalPersonId);
            orgChart.draw(dataTable, { allowHtml: true, allowCollapse: true, nodeClass: 'google-visualization-orgchart-node' });
        }

        // =======================================================================
        // ========== START OF THE CORRECTED FUNCTION ============================
        // =======================================================================
        /**
         * 核心渲染函数: [已修正] 为指定焦点人物构建DataTable
         * 新的逻辑不再局限于“焦点人物”，而是绘制整个家谱，并以正确的层级关系展示。
         * OrgChart的正确用法是：子节点的 "Manager" 列应指向其父节点的ID。
         */
        function buildDataTableForFocalPerson(personId) { // personId 参数保留，但当前逻辑会绘制全图
            const dataTable = new google.visualization.DataTable();
            dataTable.addColumn('string', 'Name');
            dataTable.addColumn('string', 'Manager');
            dataTable.addColumn('string', 'ToolTip');

            // 遍历所有家庭成员来正确建立层级关系
            familyData.forEach(person => {
                // 为了避免重复绘制（例如，妻子和丈夫各自成为一个节点），我们建立一个规则：
                // 通常以男性为节点主体，女性（配偶）显示在节点内。
                // 因此，如果一个女性有配偶，我们就不为她创建独立的行，因为她会通过 formatNodeContent 添加到她丈夫的节点里。
                if (person.gender === 'female' && person.spouseId) {
                    // 检查她的配偶是否存在于数据中，如果存在，就跳过她，让她由配偶节点来渲染
                    const spouseExists = familyData.some(p => p.id === person.spouseId);
                    if (spouseExists) {
                        return; // 跳过此成员，她将被包含在配偶的节点中
                    }
                }

                // 查找配偶信息
                const spouse = person.spouseId ? familyData.find(p => p.id === person.spouseId) : null;
                // 格式化节点内容，这部分逻辑是正确的，无需修改
                const nodeContent = formatNodeContent(person, spouse);
                
                // 【核心修正】
                // 任何一个人的管理者（Manager，即图表中的上级）应该是其父亲的ID。
                // 如果没有父亲信息，则为 null，代表他/她是顶级节点。
                const managerId = person.fatherId || null;

                dataTable.addRow([
                    { v: person.id, f: nodeContent.html }, // 节点ID和显示的HTML
                    managerId,                            // 管理者ID（即父亲ID）
                    person.tooltip                        // 悬停提示
                ]);
            });
            
            // 为焦点人物添加高亮样式类
            for (let i = 0; i < dataTable.getNumberOfRows(); i++) {
                const rowId = dataTable.getValue(i, 0);
                if(rowId === focalPersonId){
                    // 使用 setRowProperty 来附加一个 CSS 类，而不是替换它
                    dataTable.setRowProperty(i, 'className', 'highlight-node');
                }
            }

            return dataTable;
        }
        // =======================================================================
        // ========== END OF THE CORRECTED FUNCTION ==============================
        // =======================================================================

        function formatNodeContent(person, spouse) {
            let spouseHtml = '';
            if (spouse) {
                spouseHtml = ` & <span class="node-name spouse" data-id="${spouse.id}">${spouse.name}</span>`;
            }
            // 修正：现在focalPerson的判断应该用focalPersonId全局变量
            const personClass = person.id === focalPersonId ? "focal-person" : "";
            const personHtml = `<span class="node-name ${personClass}" data-id="${person.id}">${person.name}</span>`;
            
            const finalHtml = (person.gender === 'female' && spouse) ? (spouseHtml.substring(3) + ' & ' + personHtml) : (personHtml + spouseHtml);

            return {
                html: `<div>${finalHtml}</div><div class="date-info">${person.info || ''}</div>`
            };
        }

        function handleNodeClick(event) {
            const target = event.target;
            if (target.classList.contains('node-name')) {
                const personId = target.getAttribute('data-id');
                if (personId) {
                    selectedPersonId = personId;
                    focalPersonId = personId; // 点击谁，谁就是新的焦点
                    redrawAll(); // 重绘以更新高亮和详情
                }
            }
        }

        function updateDetailsPanel() {
            const content = document.getElementById('details-content');
            const actions = document.getElementById('details-actions');
            if (!selectedPersonId) {
                content.innerHTML = '<p>请点击家谱中的任意成员进行操作。</p>';
                actions.innerHTML = '';
                return;
            }
            const person = familyData.find(p => p.id === selectedPersonId);
            if (!person) {
                selectedPersonId = null;
                content.innerHTML = '<p>成员未找到。请重新选择。</p>';
                actions.innerHTML = '';
                return;
            }
            
            content.innerHTML = `<h3>${person.name}</h3><p>${person.tooltip || '暂无简介'}</p>`;
            actions.innerHTML = `<button class="action-btn" onclick="openEditModal('${person.id}')">编辑</button><button class="action-btn" onclick="deleteMember('${person.id}')" style="background-color:#dc3545; color:white;">删除</button>`;
        }

        function addMember() {
            const name = document.getElementById('newName').value.trim();
            if (!name) { alert('姓名不能为空!'); return; }
            
            const newPerson = {
                id: name.replace(/\s/g, '') + Date.now(),
                name: name,
                gender: document.getElementById('newGender').value,
                info: document.getElementById('newInfo').value.trim(),
                fatherId: document.getElementById('newFather').value || null,
                motherId: document.getElementById('newMother').value || null,
                spouseId: document.getElementById('newSpouse').value || null,
                tooltip: document.getElementById('newTooltip').value.trim()
            };
            familyData.push(newPerson);
            
            if (newPerson.spouseId) {
                const spouse = familyData.find(p => p.id === newPerson.spouseId);
                if (spouse) spouse.spouseId = newPerson.id;
            }

            ['newName', 'newInfo', 'newTooltip'].forEach(id => document.getElementById(id).value = '');
            ['newGender', 'newFather', 'newMother', 'newSpouse'].forEach(id => document.getElementById(id).selectedIndex = 0);
            
            focalPersonId = newPerson.id;
            selectedPersonId = newPerson.id;
            saveDataAndRedraw();
        }
        
        function openEditModal(personId) {
            const person = familyData.find(p => p.id === personId);
            if (!person) return;
            
            updateAllDropdowns(person.id);

            document.getElementById('editId').value = person.id;
            document.getElementById('editName').value = person.name;
            document.getElementById('editGender').value = person.gender;
            document.getElementById('editInfo').value = person.info || '';
            document.getElementById('editFather').value = person.fatherId || '';
            document.getElementById('editMother').value = person.motherId || '';
            document.getElementById('editSpouse').value = person.spouseId || '';
            document.getElementById('editTooltip').value = person.tooltip || '';

            document.getElementById('editModal').style.display = 'flex';
        }

        function saveChanges() {
            const personId = document.getElementById('editId').value;
            const personIndex = familyData.findIndex(p => p.id === personId);
            if (personIndex === -1) return;

            const person = familyData[personIndex];
            const oldSpouseId = person.spouseId;
            
            person.name = document.getElementById('editName').value.trim();
            person.gender = document.getElementById('editGender').value;
            person.info = document.getElementById('editInfo').value.trim();
            person.fatherId = document.getElementById('editFather').value || null;
            person.motherId = document.getElementById('editMother').value || null;
            person.spouseId = document.getElementById('editSpouse').value || null;
            person.tooltip = document.getElementById('editTooltip').value.trim();

            if (oldSpouseId && oldSpouseId !== person.spouseId) {
                 const oldSpouse = familyData.find(p => p.id === oldSpouseId);
                 if (oldSpouse) oldSpouse.spouseId = null;
            }
            if (person.spouseId) {
                const newSpouse = familyData.find(p => p.id === person.spouseId);
                if (newSpouse) newSpouse.spouseId = person.id;
            }

            closeEditModal();
            saveDataAndRedraw();
        }
        
        function deleteMember(personId) {
            const personIndex = familyData.findIndex(p => p.id === personId);
            if(personIndex === -1) return;
            const personName = familyData[personIndex].name;
            
            if (confirm(`确定要删除 "${personName}" 吗？\n此操作会一并移除所有与此人相关的关系链接，且不可撤销。`)) {
                familyData.splice(personIndex, 1);

                familyData.forEach(p => {
                    if (p.fatherId === personId) p.fatherId = null;
                    if (p.motherId === personId) p.motherId = null;
                    if (p.spouseId === personId) p.spouseId = null;
                });
                
                selectedPersonId = null;
                focalPersonId = familyData.length > 0 ? familyData[0].id : null;
                saveDataAndRedraw();
            }
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function updateAllDropdowns(excludeId = null) {
            const males = familyData.filter(p => p.gender === 'male' && p.id !== excludeId);
            const females = familyData.filter(p => p.gender === 'female' && p.id !== excludeId);
            const all = familyData.filter(p => p.id !== excludeId);

            populateDropdown(document.getElementById('newFather'), males, '无');
            populateDropdown(document.getElementById('editFather'), males, '无');
            populateDropdown(document.getElementById('newMother'), females, '无');
            populateDropdown(document.getElementById('editMother'), females, '无');
            populateDropdown(document.getElementById('newSpouse'), all, '无');
            populateDropdown(document.getElementById('editSpouse'), all, '无');
        }

        function populateDropdown(selectElement, optionsArray, defaultOptionText) {
            const currentValue = selectElement.value;
            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
            optionsArray.forEach(p => {
                selectElement.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            selectElement.value = currentValue;
        }

        function exportDataToFile() {
            const dataJson = JSON.stringify(familyData, null, 2);
            const blob = new Blob([dataJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `family_tree_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importDataFromFile(event) {
             const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data) && data.every(item => 'id' in item && 'name' in item)) {
                        loadData(data);
                        alert('导入成功!');
                    } else { throw new Error('Invalid format'); }
                } catch(err) { alert('文件格式错误或内容不合法!'); }
                finally { event.target.value = ''; } // 清空input，以便再次选择同名文件
            };
            reader.readAsText(file);
        }

        function resetToDefault() {
            if(confirm('确定要重置为初始演示数据吗？当前所有修改将丢失。')) {
                focalPersonId = 'JiangSiyuan';
                loadData(JSON.parse(JSON.stringify(initialFamilyData)));
            }
        }

        function switchView(viewName) {
            currentView = viewName;
            document.getElementById('orgchart_div').style.display = viewName === 'orgchart' ? 'block' : 'none';
            document.getElementById('timeline_div').style.display = viewName === 'timeline' ? 'block' : 'none';
            document.getElementById('orgchart-view-btn').classList.toggle('active', viewName === 'orgchart');
            document.getElementById('timeline-view-btn').classList.toggle('active', viewName === 'timeline');
            redrawAll();
        }

        function drawTimelineChart() {
            const timelineData = new google.visualization.DataTable();
            timelineData.addColumn({ type: 'string', id: 'Name' });
            timelineData.addColumn({ type: 'date', id: 'Start' });
            timelineData.addColumn({ type: 'date', id: 'End' });

            familyData.forEach(member => {
                const yearRegex = /\d{4}/g;
                const years = member.info ? member.info.match(yearRegex) : null;
                if (years && years.length > 0) {
                    const start = new Date(parseInt(years[0]), 0, 1);
                    const end = years.length > 1 && years[1] ? new Date(parseInt(years[1]), 11, 31) : new Date(); // 如果只有生年，则至今
                    timelineData.addRow([member.name, start, end]);
                }
            });
            if (timelineData.getNumberOfRows() > 0) {
                 timelineChart.draw(timelineData);
            } else {
                document.getElementById('timeline_div').innerHTML = "<p>没有足够的时间信息来生成时间轴。</p>";
            }
        }
    </script>
</body>
</html> -->